From 40ecad002f5fffb12778155cf5bc8302f014dbbe Mon Sep 17 00:00:00 2001
From: Pavel Raiskup <praiskup@redhat.com>
Date: Fri, 30 Mar 2012 09:16:10 +0200
Subject: [PATCH] tests: skip SIGPIPE-dependent tests in environments ignoring
 SIGPIPE

upstream commit: a7fc5ecea
---
 tests/remfiles01.at |    1 +
 tests/sigpipe.at    |    2 ++
 tests/testsuite.at  |   10 +++++++++-
 3 files changed, 12 insertions(+), 1 deletions(-)

diff --git a/tests/remfiles01.at b/tests/remfiles01.at
index 9e92521..2e88ac4 100644
--- a/tests/remfiles01.at
+++ b/tests/remfiles01.at
@@ -31,6 +31,7 @@ AT_KEYWORDS([create remove-files remfiles01 gzip])
 unset TAR_OPTIONS
 AT_CHECK([
 AT_GZIP_PREREQ
+AT_SIGPIPE_PREREQ
 AT_SORT_PREREQ
 AT_UNPRIVILEGED_PREREQ
 
diff --git a/tests/sigpipe.at b/tests/sigpipe.at
index 9edca77..3c1b590 100644
--- a/tests/sigpipe.at
+++ b/tests/sigpipe.at
@@ -26,6 +26,8 @@ AT_KEYWORDS([sigpipe])
 #             <20100319184141.GC30047@wo.int.altlinux.org>
 
 AT_CHECK([
+AT_SIGPIPE_PREREQ
+
 genfile --length 2048 --file first
 genfile --length 2048 --file second
 genfile --length 2049 --file third
diff --git a/tests/testsuite.at b/tests/testsuite.at
index ec08f24..72b773c 100644
--- a/tests/testsuite.at
+++ b/tests/testsuite.at
@@ -1,7 +1,8 @@
 # Process this file with autom4te to create testsuite. -*- Autotest -*-
 
 # Test suite for GNU tar.
-# Copyright (C) 2004, 2005, 2006, 2007, 2008 Free Software Foundation, Inc.
+# Copyright (C) 2004, 2005, 2006, 2007, 2008, 2010 Free Software
+# Foundation, Inc.
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -80,6 +81,13 @@ m4_define([AT_GZIP_PREREQ],[
 cat /dev/null | m4_if([$1],[],gzip,[$1]) - > /dev/null 2>&1 || AT_SKIP_TEST
 ])
 
+dnl AT_SIGPIPE_PREREQ - Skip test unless SIGPIPE handling is the default
+m4_define([AT_SIGPIPE_PREREQ],[
+case `(cat "$at_myself" 2>&3 | :) 3>&1 >/dev/null` in #(
+?*) AT_SKIP_TEST;;
+esac
+])
+
 dnl AT_SORT_PREREQ - Skip test if sort utility outputs unwanted data on stderr
 m4_define([AT_SORT_PREREQ],[
 test -z "`sort < /dev/null 2>&1`" || AT_SKIP_TEST
-- 
1.7.4.4

